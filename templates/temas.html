<!DOCTYPE html>
<html lang="es" data-theme="{{ 'dark' if navbar_data.dark_mode else 'light' }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temas de {{ asignatura['nombre'] }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- MathJax 3 con configuración -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            startup: {
                pageReady: function () {
                    console.log("MathJax 3 listo");
                    return MathJax.startup.defaultPageReady();
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
</head>

<body>
    {% include '_navbar.html' %}
    {% include '_sidebar.html' %}
    <main class="content">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-semibold">Temas de {{ asignatura['nombre'] }}</h1>
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('agregar_tema', asignatura_id=asignatura['id']) }}" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Nuevo Tema
            </a>
            {% endif %}
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        {% if temas %}
        <div class="space-y-4 max-w-3xl">
            {% for tema in temas %}
            {% include '_tema_item.html' %}
            {% endfor %}
        </div>
        {% else %}
        <div class="card">
            <p class="text-sm">No hay temas disponibles.</p>
        </div>
        {% endif %}
    </main>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <script>
        function toggleTema(contentDiv, temaId) {
            console.log("toggleTema llamado con temaId:", temaId);
            contentDiv.classList.toggle('hidden');
            if (!contentDiv.classList.contains('hidden')) {
                const element = document.getElementById(temaId);
                console.log("Elemento encontrado:", element);
                if (!element) {
                    console.error("No se encontró el elemento con ID:", temaId);
                    return;
                }
                const markdownContent = element.getAttribute('data-markdown');
                console.log("MarkdownContent:", markdownContent);
                if (markdownContent) {
                    try {
                        const htmlContent = marked.parse(markdownContent);
                        console.log("HTML generado:", htmlContent);
                        element.innerHTML = htmlContent;
                        console.log("HTML insertado en el DOM");
                        if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                            console.log("Renderizando con MathJax...");
                            MathJax.typeset([element]);
                            console.log("MathJax ejecutado");
                        } else {
                            console.log("MathJax no está listo, esperando...");
                            setTimeout(() => {
                                if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                                    console.log("Reintentando MathJax...");
                                    MathJax.typeset([element]);
                                    console.log("MathJax reintentado");
                                } else {
                                    console.error("MathJax no se cargó correctamente después de esperar");
                                }
                            }, 2000); // Aumentamos a 2 segundos
                        }
                    } catch (e) {
                        console.error("Error al procesar Markdown o MathJax:", e);
                    }
                } else {
                    console.log("No hay markdownContent para procesar");
                }
            }
        }
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Marked:", typeof marked);
            console.log("MathJax:", typeof MathJax);
        });
    </script>

</body>

</html>